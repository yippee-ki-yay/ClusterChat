(function() {
	angular.module("chatApp").controller("chatController", chatController);
	
	chatController.$inject = ['$scope', '$websocket', '$location', 'userService'];
	
	function chatController($scope, $websocket, $location, userService) {
	
		$scope.msgList = [];
		$scope.userList = [];
		
		var dataStream = $websocket('ws://192.168.1.100:8080/ChatAppClient/websocket');
		
		dataStream.onMessage(function(message) {
			
			var msg = JSON.parse(message.data);
			
			console.log(msg.type);
			
			if(msg.type == "msg") {
				$scope.msgList.push(msg);
			} else if(msg.type == "user") {
				$scope.userList.push(msg.name);
			}
			
			
		});
		
		$scope.sendMsg = function()
		{
			var privateMsg = false;
			var toUser = "";
			
			var privData = {privateMsg: false, toUser: ""};
			
			var msgToServer = findUserInMsg(privData);
			
			console.log(privateMsg + " : " + toUser);
			
			var msgData;
			
			if(privateMsg) {
				msgData = {"to": toUser, "type" : "msg", "content" : msgToServer, "from": userService.getUser()};
			} else {
				msgData = {"type" : "msg", "content" : msgToServer, "from": userService.getUser()};
			}
			
			dataStream.send(msgData);
			$scope.msgText = "";
		}
		
		$scope.sendUserLogin = (function() {
			var userData = {"type" : "user", "name" : userService.getUser()};
			
			dataStream.send(userData)
			
		})();
		
		$scope.logout = function() {
			console.log("logout");
			userService.logout();
			
			$location.path("/login/");
			
		}
		
		function findUserInMsg( privateMsg, toUser) {
			for(var i = 0; i < $scope.userList.length; ++i) {
				var nameNick = $scope.userList[i] + ":";
				var index = $scope.msgText.search(nameNick);
				if(index != -1){
					privateMsg = true;
					toUser = $scope.userList[i].substr(0, $scope.userList[i].length);
					return $scope.msgText.substr(index + $scope.userList[i].length, $scope.msgText.length);
				} else {
					privateMsg = false;
					return $scope.msgText;
				}
			}
		}
		
	};
})();

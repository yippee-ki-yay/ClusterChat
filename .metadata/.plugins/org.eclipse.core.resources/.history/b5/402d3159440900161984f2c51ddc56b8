(function() {
	angular.module("chatApp").controller("chatController", chatController);
	
	chatController.$inject = ['$scope', '$websocket', '$location', 'userService', '$http'];
	
	function chatController($scope, $websocket, $location, userService, $http) {
	
		$scope.msgList = [];
		$scope.userList = [];
		
		var dataStream = $websocket('ws://192.168.1.100:8080/ChatAppClient/websocket');
		
		 $http.get("http://192.168.1.100:8080/UserAppClient/rest/users/list/")
		    .then(function(response) {
		        $scope.myWelcome = response.data;
		    });
		
		dataStream.onMessage(function(message) {
			
			var msg = JSON.parse(message.data);
			
			console.log(msg.type);
			
			if(msg.type == "msg") {
				$scope.msgList.push(msg);
			} else if(msg.type == "user") {
				$scope.userList.push(msg.name);
			}
			
			
		});
		
		$scope.sendMsg = function()
		{
			
			var privData = {privateMsg: false, toUser: ""};
			
			var msgToServer = findUserInMsg(privData);
			
			console.log(privData.privateMsg + " : " + privData.toUser);
			
			var msgData;
			
			if(privData.privateMsg) {
				msgData = {"to": privData.toUser, "type" : "msg", "content" : msgToServer, "from": userService.getUser()};
			} else {
				msgData = {"type" : "msg", "content" : msgToServer, "from": userService.getUser()};
			}
			
			dataStream.send(msgData);
			$scope.msgText = "";
		}
		
		$scope.sendUserLogin = (function() {
			var userData = {"name" : userService.getUser(), "type" : "user"};
			
			dataStream.send(userData)
			
		})();
		
		$scope.logout = function() {
			console.log("logout");
			userService.logout();
			
			$location.path("/login/");
			
		}
		
		function findUserInMsg( privData) {
			for(var i = 0; i < $scope.userList.length; ++i) {
				var nameNick = $scope.userList[i] + ":";
				var index = $scope.msgText.search(nameNick);
				if(index != -1){
					privData.privateMsg = true;
					privData.toUser = $scope.userList[i].substr(0, $scope.userList[i].length);
					return $scope.msgText.substr(index + $scope.userList[i].length, $scope.msgText.length);
				} 
			}
			
			privData.privateMsg = false;
			return $scope.msgText;
		}
		
	};
})();
